#!/bin/bash

# Pre-commit hook for TelemetryFlow Go projects
# Runs: gofmt, golint, go vet, and security scan

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo -e "${YELLOW}No Go files staged for commit. Skipping Go checks.${NC}"
    exit 0
fi

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

FAILED=0

# 1. Check gofmt
echo -e "\n${YELLOW}[1/4] Running gofmt...${NC}"
GOFMT_OUTPUT=$(gofmt -l $STAGED_GO_FILES 2>&1 || true)
if [ -n "$GOFMT_OUTPUT" ]; then
    echo -e "${RED}The following files need formatting:${NC}"
    echo "$GOFMT_OUTPUT"
    echo -e "${YELLOW}Run 'gofmt -w <file>' to fix${NC}"
    FAILED=1
else
    echo -e "${GREEN}gofmt passed${NC}"
fi

# 2. Run go vet
echo -e "\n${YELLOW}[2/4] Running go vet...${NC}"
if ! go vet ./... 2>&1; then
    echo -e "${RED}go vet found issues${NC}"
    FAILED=1
else
    echo -e "${GREEN}go vet passed${NC}"
fi

# 3. Run golint (if available)
echo -e "\n${YELLOW}[3/4] Running golint...${NC}"
if command_exists golint; then
    LINT_OUTPUT=$(golint ./... 2>&1 || true)
    if [ -n "$LINT_OUTPUT" ]; then
        echo -e "${RED}golint found issues:${NC}"
        echo "$LINT_OUTPUT"
        # golint issues are warnings, not failures
        echo -e "${YELLOW}(golint issues are warnings only)${NC}"
    else
        echo -e "${GREEN}golint passed${NC}"
    fi
elif command_exists staticcheck; then
    if ! staticcheck ./... 2>&1; then
        echo -e "${RED}staticcheck found issues${NC}"
        FAILED=1
    else
        echo -e "${GREEN}staticcheck passed${NC}"
    fi
else
    echo -e "${YELLOW}golint/staticcheck not installed. Skipping lint check.${NC}"
    echo -e "${YELLOW}Install with: go install golang.org/x/lint/golint@latest${NC}"
    echo -e "${YELLOW}Or: go install honnef.co/go/tools/cmd/staticcheck@latest${NC}"
fi

# 4. Run security scan (gosec if available)
echo -e "\n${YELLOW}[4/4] Running security scan...${NC}"
if command_exists gosec; then
    GOSEC_OUTPUT=$(gosec -quiet ./... 2>&1 || true)
    if [ -n "$GOSEC_OUTPUT" ] && echo "$GOSEC_OUTPUT" | grep -q "Severity"; then
        echo -e "${RED}gosec found security issues:${NC}"
        echo "$GOSEC_OUTPUT"
        FAILED=1
    else
        echo -e "${GREEN}gosec passed${NC}"
    fi
elif command_exists govulncheck; then
    if ! govulncheck ./... 2>&1; then
        echo -e "${RED}govulncheck found vulnerabilities${NC}"
        FAILED=1
    else
        echo -e "${GREEN}govulncheck passed${NC}"
    fi
else
    echo -e "${YELLOW}gosec/govulncheck not installed. Skipping security scan.${NC}"
    echo -e "${YELLOW}Install with: go install github.com/securego/gosec/v2/cmd/gosec@latest${NC}"
    echo -e "${YELLOW}Or: go install golang.org/x/vuln/cmd/govulncheck@latest${NC}"
fi

if [ $FAILED -ne 0 ]; then
    echo -e "\n${RED}Pre-commit checks failed. Please fix the issues above.${NC}"
    exit 1
fi

echo -e "\n${GREEN}All pre-commit checks passed!${NC}"
exit 0
